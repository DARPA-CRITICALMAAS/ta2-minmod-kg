version: 2
resources: json
preprocessing:
  - type: pmap
    path: ["MineralSite", ..]
    output: site_uri
    code: |
      from slugify import slugify
      import hashlib

      coms = []
      if "name" in value:
        coms.append(slugify(value["name"]))
      source_id = value["source_id"]
      record_id = value["record_id"]
      if source_id.startswith("http://"):
        source_id = source_id[7:]
      elif source_id.startswith("https://"):
        source_id = source_id[8:]
      coms.append(slugify(source_id))
      if isinstance(record_id, int):
        coms.append(str(record_id))
      else:
        coms.append(slugify(record_id))

      id = "__".join(coms)
      if len(id) > 80:
        id = id[:80] + "__" + hashlib.sha256(id.encode()).hexdigest()[:8]
      return "https://minmod.isi.edu/resource/site__" + id
  - type: pmap
    path: ["MineralSite", .., ["mineral_inventory"], .., ["reference"]]
    code: |
      if 'id' not in value:
        value['id'] = str(context.get_index())
      return value
  - type: pmap
    path: ["MineralSite", .., ["mineral_inventory"], .., ["reference"], "document"]
    code: |
      if 'id' not in value:
        value['id'] = str(context.get_index())
      return value
attributes:
  site_name: ["MineralSite", .., ["name"]]
  site_source_id: ["MineralSite", .., "source_id"]
  site_record_id: ["MineralSite", .., "record_id"]
  site_type: ["MineralSite", .., ["site_type"]]
  site_rank: ["MineralSite", .., ["site_rank"]]

  deposit_type_name: ["MineralSite", .., ["deposit_type_candidate"], .., "observed_name"]
  deposit_type_source: ["MineralSite", .., ["deposit_type_candidate"], .., "source"]
  deposit_type_confidence: ["MineralSite", .., ["deposit_type_candidate"], .., "confidence"]
  deposit_type_normalized_uri: ["MineralSite", .., ["deposit_type_candidate"], .., ["normalized_uri"]]

  location: ["MineralSite", .., ["location_info"], ["location"]]
  country: ["MineralSite", .., ["location_info"], ["country"]]
  extracted_country: ["MineralSite", .., ["location_info"], ["extracted_country"]]
  state: ["MineralSite", .., ["location_info"], ["state_or_province"]]
  extracted_state: ["MineralSite", .., ["location_info"], ["extracted_state_or_province"]]
  crs: ["MineralSite", .., ["location_info"], ["crs"]]

  geology_info_age: ["MineralSite", .., ["geology_info"], ["age"]]
  geology_info_unit_name: ["MineralSite", .., ["geology_info"], ["unit_name"]]
  geology_info_description: ["MineralSite", .., ["geology_info"], ["description"]]
  geology_info_lithology: ["MineralSite", .., ["geology_info"], ["lithology"]]
  geology_info_process: ["MineralSite", .., ["geology_info"], ["process"]]
  geology_info_environment: ["MineralSite", .., ["geology_info"], ["environment"]]
  geology_info_comments: ["MineralSite", .., ["geology_info"], ["comments"]]

  inv_commodity: ["MineralSite", .., ["mineral_inventory"], .., "commodity"]
  inv_observed_commodity: ["MineralSite", .., ["mineral_inventory"], .., ["observed_commodity"]]
  inv_zone: ["MineralSite", .., ["mineral_inventory"], .., ["zone"]]
  inv_date: ["MineralSite", .., ["mineral_inventory"], .., ["date"]]
  inv_category: ["MineralSite", .., ["mineral_inventory"], .., ["category"], ..]

  ore_value: ["MineralSite", .., ["mineral_inventory"], .., ["ore"], ["ore_value"]]
  ore_unit: ["MineralSite", .., ["mineral_inventory"], .., ["ore"], ["ore_unit"]]

  grade_value: ["MineralSite", .., ["mineral_inventory"], .., ["grade"], ["grade_value"]]
  grade_unit: ["MineralSite", .., ["mineral_inventory"], .., ["grade"], ["grade_unit"]]

  cutoff_grade_value: ["MineralSite", .., ["mineral_inventory"], .., ["cutoff_grade"], ["grade_value"]]
  cutoff_grade_unit: ["MineralSite", .., ["mineral_inventory"], .., ["cutoff_grade"], ["grade_unit"]]

  refid: ["MineralSite", .., ["mineral_inventory"], .., ["reference"], "id"]
  docid: ["MineralSite", .., ["mineral_inventory"], .., ["reference"], "document", "id"]
  doc_uri: ["MineralSite", .., ["mineral_inventory"], .., ["reference"], "document", ["uri"]]
  doi: ["MineralSite", .., ["mineral_inventory"], .., ["reference"], "document", ["doi"]]
  volume: ["MineralSite", .., ["mineral_inventory"], .., ["reference"], "document", ["volume"]]
  doc_issue: ["MineralSite", .., ["mineral_inventory"], .., ["reference"], "document", ["issue"]]
  doc_year: ["MineralSite", .., ["mineral_inventory"], .., ["reference"], "document", ["year"]]
  doc_month: ["MineralSite", .., ["mineral_inventory"], .., ["reference"], "document", ["month"]]
  authors: ["MineralSite", .., ["mineral_inventory"], .., ["reference"], "document", ["authors"]]
  journal: ["MineralSite", .., ["mineral_inventory"], .., ["reference"], "document", ["journal"]]
  doc_desc: ["MineralSite", .., ["mineral_inventory"], .., ["reference"], "document", ["description"]]
  doc_title: ["MineralSite", .., ["mineral_inventory"], .., ["reference"], "document", ["title"]]

  page_no: ["MineralSite", .., ["mineral_inventory"], .., ["reference"], ["page_info"], .., ["page"]]

  x_min: ["MineralSite", .., ["mineral_inventory"], .., ["reference"], ["page_info"], .., ["bounding_box"], "x_min"]
  x_max: ["MineralSite", .., ["mineral_inventory"], .., ["reference"], ["page_info"], .., ["bounding_box"], "x_max"]
  y_min: ["MineralSite", .., ["mineral_inventory"], .., ["reference"], ["page_info"], .., ["bounding_box"], "y_min"]
  y_max: ["MineralSite", .., ["mineral_inventory"], .., ["reference"], ["page_info"], .., ["bounding_box"], "y_max"]

alignments:
  - type: auto

semantic_model:
  mno:MineralSite:1:
    properties:
      - [drepr:uri, site_uri]
      - [rdfs:label, site_name]
      - [mno:source_id, site_source_id]
      - [mno:record_id, site_record_id]
      - [mno:site_type, site_type]
      - [mno:site_rank, site_rank]
    links:
      - [mno:deposit_type_candidate, mno:DepositTypeCandidate:1]
      - [mno:location_info, mno:LocationInfo:1]
      - [mno:geology_info, mno:GeologyInfo:1]
      - [mno:mineral_inventory, mno:MineralInventory:1]

  mno:DepositTypeCandidate:1:
    properties:
      - [mno:observed_name, deposit_type_name]
      - [mno:source, deposit_type_source]
      - [mno:normalized_uri, deposit_type_normalized_uri, drepr:uri]
      - [mno:confidence, deposit_type_confidence]

  mno:LocationInfo:1:
    properties:
      - [mno:country, country, drepr:uri]
      - [mno:extracted_country, extracted_country]
      - [mno:crs, crs, drepr:uri]
      - [mno:state_or_province, state, drepr:uri]
      - [mno:extracted_state_or_province, extracted_state]
      - [mno:location, location, geo:wktLiteral]
    subject: country

  mno:GeologyInfo:1:
    properties:
      - [mno:unit_name, geology_info_unit_name]
      - [mno:age, geology_info_age]
      - [mno:lithology, geology_info_lithology]
      - [mno:comments, geology_info_comments]
      - [mno:description, geology_info_description]
      - [mno:process, geology_info_process]
    subject: geology_info_unit_name

  mno:MineralInventory:1:
    properties:
      - [mno:date, inv_date, xsd:date]
      - [mno:zone, inv_zone]
      - [mno:commodity, inv_commodity, drepr:uri]
      - [mno:observed_commodity, inv_observed_commodity]
      - [mno:category, inv_category, drepr:uri]
    links:
      - [mno:reference, mno:Reference:1]
      - [mno:ore, mno:Ore:1]
      - [mno:grade, mno:Grade:1]
      - [mno:cutoff_grade, mno:Grade:cutoff]
    subject: inv_commodity

  mno:Reference:1:
    properties:
      - [drepr:blank, refid]
    links:
      - [mno:document, mno:Document:1]
      - [mno:page_info, mno:PageInfo:1]

  mno:PageInfo:1:
    properties:
      - [mno:page, page_no]
    links:
      - [mno:bounding_box, mno:BoundingBox:1]

  mno:BoundingBox:1:
    properties:
      - [mno:x_min, x_min]
      - [mno:x_max, x_max]
      - [mno:y_min, y_min]
      - [mno:y_max, y_max]

  mno:Document:1:
    properties:
      - [drepr:blank, docid]
      - [mno:uri, doc_uri]
      - [mno:doi, doi]
      - [mno:journal, journal]
      - [mno:authors, authors]
      - [mno:description, doc_desc]
      - [mno:title, doc_title]
      - [mno:volume, volume]
      - [mno:issue, doc_issue]
      - [mno:month, doc_month]
      - [mno:year, doc_year]

  mno:Ore:1:
    properties:
      - [mno:ore_value, ore_value, xsd:decimal]
      - [mno:ore_unit, ore_unit, drepr:uri]
    subject: ore_value

  mno:Grade:1:
    properties:
      - [mno:grade_value, grade_value, xsd:decimal]
      - [mno:grade_unit, grade_unit, drepr:uri]
    subject: grade_value

  mno:Grade:cutoff:
    properties:
      - [mno:grade_value, cutoff_grade_value, xsd:decimal]
      - [mno:grade_unit, cutoff_grade_unit, drepr:uri]
    subject: cutoff_grade_value

  prefixes:
    mno: https://minmod.isi.edu/ontology/
    geokb: https://geokb.wikibase.cloud/entity/
    rdf: http://www.w3.org/1999/02/22-rdf-syntax-ns#
    rdfs: http://www.w3.org/2000/01/rdf-schema#
    xsd: http://www.w3.org/2001/XMLSchema#
    owl: http://www.w3.org/2002/07/owl#
    drepr: https://purl.org/drepr/1.0/
    geo: http://www.opengis.net/ont/geosparql#
    gkbi: https://geokb.wikibase.cloud/entity/
    gkbp: https://geokb.wikibase.cloud/wiki/Property/
